# Files Service Implementation Documentation

## Overview

The Files Service handles all file upload operations including KYC/KYB documents, generic files, and bulk payout CSVs. It uses a specialized API client (`fileUploadClient`) to properly handle `multipart/form-data` requests, which require different handling than standard JSON API calls.

---

## Table of Contents

1. [Why a Separate File Upload Client?](#why-a-separate-file-upload-client)
2. [Architecture](#architecture)
3. [File Upload Client](#file-upload-client)
4. [API Functions](#api-functions)
5. [React Query Hooks](#react-query-hooks)
6. [Usage Examples](#usage-examples)
7. [Type Definitions](#type-definitions)
8. [Error Handling](#error-handling)
9. [Best Practices](#best-practices)

---

## Why a Separate File Upload Client?

### The Problem with Standard API Clients

Standard API clients (like `apiClient`) are configured for JSON requests:
```typescript
// Standard API client
headers: {
  'Content-Type': 'application/json'
}
```

### File Upload Requirements

File uploads require `multipart/form-data` with a **boundary**:
```typescript
// File upload headers (set by browser)
headers: {
  'Content-Type': 'multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW'
}
```

### Key Differences

| Aspect | Standard API Client | File Upload Client |
|--------|-------------------|-------------------|
| **Content-Type** | `application/json` | `multipart/form-data` |
| **Boundary** | Not needed | Auto-generated by browser |
| **Data Format** | JSON object | FormData object |
| **Manual Setting** | Set explicitly | Must NOT be set manually |
| **Progress Tracking** | Not needed | Essential for UX |

### Why We Can't Use One Client for Both

```typescript
// ❌ WRONG: Using standard client for files
await apiClient.post('/files/upload', formData); 
// Problem: Content-Type is 'application/json', server expects multipart

// ❌ WRONG: Manually setting Content-Type
await apiClient.post('/files/upload', formData, {
  headers: { 'Content-Type': 'multipart/form-data' }
});
// Problem: Missing boundary, server can't parse

// ✅ CORRECT: Using specialized file upload client
await fileUploadClient.upload('/files/upload', formData);
// Browser automatically sets: 'multipart/form-data; boundary=...'
```

---

## Architecture

### Folder Structure

```
features/files/
├── api/
│   └── index.ts          # API functions using fileUploadClient
├── hooks/
│   └── index.ts          # React Query hooks
└── types/
    └── index.ts          # TypeScript types and interfaces

lib/
└── fileUploadClient.ts   # Specialized upload client
```

### Data Flow

```
Component
  ↓
React Query Hook (useMutation/useQuery)
  ↓
API Function (uploadKYCDocument, etc.)
  ↓
File Upload Client (fileUploadClient)
  ↓
Axios with multipart/form-data
  ↓
Backend API
```

---

## File Upload Client

### Location
`lib/fileUploadClient.ts`

### Key Features

1. **Automatic Boundary Handling**
```typescript
// IMPORTANT: Do NOT set Content-Type for FormData
if (config.data instanceof FormData) {
  delete config.headers['Content-Type'];
}
// Let browser set it with correct boundary
```

2. **Progress Tracking**
```typescript
async uploadWithProgress<T>(
  url: string,
  formData: FormData,
  onProgress?: (progress: number) => void
): Promise<{ data: T }>
```

3. **Authentication**
```typescript
// Automatically adds Bearer token
config.headers.Authorization = `Bearer ${token}`;
```

4. **Error Handling**
```typescript
// Extracts meaningful error messages
const message = error.response.data?.message || 'File upload failed';
throw new Error(message);
```

### Methods

#### `upload<T>(url, formData, config?)`
Basic upload without progress tracking.

```typescript
const response = await fileUploadClient.upload<UploadResponse>(
  '/api/v1/files/kyc?documentType=TAX_ID',
  formData
);
```

#### `uploadWithProgress<T>(url, formData, onProgress)`
Upload with progress callback.

```typescript
const response = await fileUploadClient.uploadWithProgress<UploadResponse>(
  '/api/v1/files/kyc?documentType=TAX_ID',
  formData,
  (progress) => {
    console.log(`Upload progress: ${progress}%`);
  }
);
```

#### `get<T>(url, config?)`
Standard GET request for non-upload endpoints.

```typescript
const response = await fileUploadClient.get<FileDetails>(
  '/api/v1/files/123'
);
```

#### `delete<T>(url, config?)`
DELETE request for file removal.

```typescript
const response = await fileUploadClient.delete<DeleteResponse>(
  '/api/v1/files/123'
);
```

---

## API Functions

### 1. Upload KYC Document

```typescript
uploadKYCDocument(
  request: UploadKYCDocumentRequest,
  onProgress?: (progress: number) => void
): Promise<UploadKYCDocumentResponse>
```

**Request:**
```typescript
{
  file: File,
  documentType: 'BUSINESS_REGISTRATION' | 'TAX_ID' | 'DIRECTOR_ID' | 'PROOF_OF_ADDRESS',
  environment?: 'sandbox' | 'production'
}
```

**Response:**
```typescript
{
  fileId: string,
  kycDocumentId: string,
  status: 'PENDING' | 'APPROVED' | 'REJECTED'
}
```

**Endpoint:** `POST /api/v1/files/kyc?documentType={type}&environment={env}`

---

### 2. Generic File Upload

```typescript
uploadFile(
  request: UploadFileRequest,
  onProgress?: (progress: number) => void
): Promise<UploadFileResponse>
```

**Request:**
```typescript
{
  file: File,
  type: 'LOGO' | 'INVOICE' | 'RECEIPT' | 'OTHER',
  environment?: 'sandbox' | 'production'
}
```

**Response:**
```typescript
{
  id: string,
  filename: string,
  storagePath: string,
  size: number
}
```

**Endpoint:** `POST /api/v1/files/upload?type={type}&environment={env}`

---

### 3. Upload Payout CSV

```typescript
uploadPayoutCSV(
  request: UploadPayoutCSVRequest,
  onProgress?: (progress: number) => void
): Promise<UploadPayoutCSVResponse>
```

**Request:**
```typescript
{
  file: File,
  environment?: 'sandbox' | 'production'
}
```

**Response:**
```typescript
{
  id: string,
  filename: string,
  rowCount: number,
  validationStatus: 'VALID' | 'INVALID' | 'PENDING'
}
```

**Endpoint:** `POST /api/v1/files/payout-csv?environment={env}`

---

### 4. List KYC Documents

```typescript
listKYCDocuments(): Promise<ListKYCDocumentsResponse>
```

**Response:**
```typescript
{
  documents: [
    {
      id: string,
      documentType: 'BUSINESS_REGISTRATION' | ...,
      status: 'PENDING' | 'APPROVED' | 'REJECTED',
      fileId: string,
      filename: string,
      uploadedAt: string,
      reviewedAt?: string,
      rejectionReason?: string
    }
  ]
}
```

**Endpoint:** `GET /api/v1/files/kyc`

---

### 5. Get File Details

```typescript
getFileDetails(fileId: string): Promise<GetFileDetailsResponse>
```

**Response:**
```typescript
{
  id: string,
  type: string,
  filename: string,
  size: number,
  mimeType: string,
  uploadedAt: string
}
```

**Endpoint:** `GET /api/v1/files/{fileId}`

---

### 6. Generate Signed URL

```typescript
generateSignedURL(fileId: string): Promise<GenerateSignedURLResponse>
```

**Response:**
```typescript
{
  url: string,
  expiresAt: string
}
```

**Endpoint:** `GET /api/v1/files/{fileId}/signed-url`

---

### 7. Delete File

```typescript
deleteFile(fileId: string): Promise<DeleteFileResponse>
```

**Response:**
```typescript
{
  message: string
}
```

**Endpoint:** `DELETE /api/v1/files/{fileId}`

---

### 8. Upload Multiple KYC Documents (Helper)

```typescript
uploadMultipleKYCDocuments(
  documents: UploadKYCDocumentRequest[],
  onProgress?: (progress: number) => void
): Promise<UploadKYCDocumentResponse[]>
```

**Purpose:** Upload multiple KYC documents sequentially with overall progress tracking.

**Example:**
```typescript
const documents = [
  { file: taxIdFile, documentType: 'TAX_ID' },
  { file: regFile, documentType: 'BUSINESS_REGISTRATION' }
];

const results = await uploadMultipleKYCDocuments(documents, (progress) => {
  console.log(`Overall progress: ${progress}%`);
});
```

---

## React Query Hooks

### Upload Hooks (Mutations)

#### `useUploadKYCDocument(onProgress?)`

```typescript
const uploadKYC = useUploadKYCDocument((progress) => {
  setUploadProgress(progress);
});

await uploadKYC.mutateAsync({
  file: selectedFile,
  documentType: 'TAX_ID',
  environment: 'sandbox'
});
```

#### `useUploadFile(onProgress?)`

```typescript
const uploadFile = useUploadFile((progress) => {
  console.log(`Progress: ${progress}%`);
});

await uploadFile.mutateAsync({
  file: logoFile,
  type: 'LOGO'
});
```

#### `useUploadPayoutCSV(onProgress?)`

```typescript
const uploadCSV = useUploadPayoutCSV((progress) => {
  setProgress(progress);
});

await uploadCSV.mutateAsync({
  file: csvFile,
  environment: 'production'
});
```

#### `useUploadMultipleKYCDocuments(onProgress?)`

```typescript
const uploadMultiple = useUploadMultipleKYCDocuments((progress) => {
  setOverallProgress(progress);
});

await uploadMultiple.mutateAsync([
  { file: file1, documentType: 'TAX_ID' },
  { file: file2, documentType: 'BUSINESS_REGISTRATION' }
]);
```

#### `useDeleteFile()`

```typescript
const deleteFile = useDeleteFile();

await deleteFile.mutateAsync(fileId);
```

---

### Query Hooks

#### `useListKYCDocuments(enabled?)`

```typescript
const { data, isLoading } = useListKYCDocuments();

const documents = data?.documents || [];
```

#### `useGetFileDetails(fileId, enabled?)`

```typescript
const { data: fileDetails } = useGetFileDetails(fileId);

console.log(fileDetails?.filename);
```

#### `useGenerateSignedURL(fileId, enabled?)`

```typescript
const { data: signedUrl } = useGenerateSignedURL(fileId);

// Use the URL to download/display file
<a href={signedUrl?.url}>Download</a>
```

---

## Usage Examples

### Example 1: Upload Single KYC Document with Progress

```typescript
import { useState } from 'react';
import { useUploadKYCDocument } from '@/features/files/hooks';

function KYCUploadForm() {
  const [progress, setProgress] = useState(0);
  const [file, setFile] = useState<File | null>(null);
  
  const uploadKYC = useUploadKYCDocument((progress) => {
    setProgress(progress);
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!file) return;

    try {
      const result = await uploadKYC.mutateAsync({
        file,
        documentType: 'TAX_ID',
        environment: 'sandbox'
      });

      console.log('Upload successful:', result);
      alert(`Document uploaded! ID: ${result.kycDocumentId}`);
    } catch (error) {
      console.error('Upload failed:', error);
      alert('Upload failed. Please try again.');
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="file"
        accept=".pdf,.jpg,.png"
        onChange={(e) => setFile(e.target.files?.[0] || null)}
      />
      
      <button 
        type="submit" 
        disabled={!file || uploadKYC.isPending}
      >
        {uploadKYC.isPending ? `Uploading... ${progress}%` : 'Upload'}
      </button>

      {uploadKYC.isPending && (
        <div className="progress-bar">
          <div style={{ width: `${progress}%` }} />
        </div>
      )}
    </form>
  );
}
```

---

### Example 2: Upload Multiple KYC Documents

```typescript
import { useState } from 'react';
import { useUploadMultipleKYCDocuments } from '@/features/files/hooks';
import type { DocumentType } from '@/features/files/types';

function MultipleKYCUpload() {
  const [files, setFiles] = useState<{
    file: File;
    documentType: DocumentType;
  }[]>([]);
  const [progress, setProgress] = useState(0);

  const uploadMultiple = useUploadMultipleKYCDocuments((progress) => {
    setProgress(progress);
  });

  const addFile = (file: File, documentType: DocumentType) => {
    setFiles([...files, { file, documentType }]);
  };

  const handleUpload = async () => {
    try {
      const results = await uploadMultiple.mutateAsync(files);
      
      console.log('All uploads successful:', results);
      alert(`Uploaded ${results.length} documents!`);
      setFiles([]);
    } catch (error) {
      console.error('Upload failed:', error);
    }
  };

  return (
    <div>
      <h3>Upload KYC Documents</h3>
      
      {/* Tax ID */}
      <div>
        <label>Tax ID Certificate:</label>
        <input
          type="file"
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) addFile(file, 'TAX_ID');
          }}
        />
      </div>

      {/* Business Registration */}
      <div>
        <label>Business Registration:</label>
        <input
          type="file"
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) addFile(file, 'BUSINESS_REGISTRATION');
          }}
        />
      </div>

      {/* Director ID */}
      <div>
        <label>Director ID:</label>
        <input
          type="file"
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) addFile(file, 'DIRECTOR_ID');
          }}
        />
      </div>

      <button
        onClick={handleUpload}
        disabled={files.length === 0 || uploadMultiple.isPending}
      >
        {uploadMultiple.isPending 
          ? `Uploading... ${progress}%` 
          : `Upload ${files.length} Documents`}
      </button>

      {uploadMultiple.isPending && (
        <div className="progress">
          <div style={{ width: `${progress}%` }}>
            {progress}%
          </div>
        </div>
      )}
    </div>
  );
}
```

---

### Example 3: List and Download KYC Documents

```typescript
import { useListKYCDocuments, useGenerateSignedURL } from '@/features/files/hooks';
import { useState } from 'react';

function KYCDocumentsList() {
  const { data, isLoading } = useListKYCDocuments();
  const [selectedFileId, setSelectedFileId] = useState<string | null>(null);
  
  const { data: signedUrl } = useGenerateSignedURL(
    selectedFileId || '',
    !!selectedFileId
  );

  const handleDownload = (fileId: string) => {
    setSelectedFileId(fileId);
  };

  // Auto-download when signed URL is ready
  useEffect(() => {
    if (signedUrl?.url) {
      window.open(signedUrl.url, '_blank');
      setSelectedFileId(null);
    }
  }, [signedUrl]);

  if (isLoading) return <div>Loading documents...</div>;

  const documents = data?.documents || [];

  return (
    <div>
      <h3>Your KYC Documents</h3>
      
      {documents.length === 0 ? (
        <p>No documents uploaded yet.</p>
      ) : (
        <table>
          <thead>
            <tr>
              <th>Document Type</th>
              <th>Filename</th>
              <th>Status</th>
              <th>Uploaded</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {documents.map((doc) => (
              <tr key={doc.id}>
                <td>{doc.documentType}</td>
                <td>{doc.filename}</td>
                <td>
                  <span className={`status-${doc.status.toLowerCase()}`}>
                    {doc.status}
                  </span>
                </td>
                <td>{new Date(doc.uploadedAt).toLocaleDateString()}</td>
                <td>
                  <button onClick={() => handleDownload(doc.fileId)}>
                    Download
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}
```

---

### Example 4: Upload with Drag & Drop

```typescript
import { useState } from 'react';
import { useUploadFile } from '@/features/files/hooks';

function DragDropUpload() {
  const [isDragging, setIsDragging] = useState(false);
  const [progress, setProgress] = useState(0);

  const uploadFile = useUploadFile((progress) => {
    setProgress(progress);
  });

  const handleDrop = async (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);

    const file = e.dataTransfer.files[0];
    if (!file) return;

    try {
      const result = await uploadFile.mutateAsync({
        file,
        type: 'OTHER'
      });

      alert(`File uploaded: ${result.filename}`);
    } catch (error) {
      alert('Upload failed');
    }
  };

  return (
    <div
      onDragOver={(e) => {
        e.preventDefault();
        setIsDragging(true);
      }}
      onDragLeave={() => setIsDragging(false)}
      onDrop={handleDrop}
      className={`dropzone ${isDragging ? 'dragging' : ''}`}
    >
      {uploadFile.isPending ? (
        <div>
          <p>Uploading... {progress}%</p>
          <div className="progress-bar">
            <div style={{ width: `${progress}%` }} />
          </div>
        </div>
      ) : (
        <p>Drag and drop a file here</p>
      )}
    </div>
  );
}
```

---

## Type Definitions

### Document Types

```typescript
type DocumentType = 
  | 'BUSINESS_REGISTRATION'
  | 'TAX_ID'
  | 'DIRECTOR_ID'
  | 'PROOF_OF_ADDRESS';

type FileType = 
  | 'LOGO'
  | 'INVOICE'
  | 'RECEIPT'
  | 'OTHER';

type Environment = 'sandbox' | 'production';

type DocumentStatus = 
  | 'PENDING'
  | 'APPROVED'
  | 'REJECTED'
  | 'EXPIRED';
```

### Interfaces

See `features/files/types/index.ts` for complete type definitions.

---

## Error Handling

### Common Errors

#### 1. File Too Large
```typescript
try {
  await uploadKYC.mutateAsync({ file, documentType: 'TAX_ID' });
} catch (error) {
  if (error.message.includes('File size exceeds')) {
    alert('File is too large. Maximum size is 10MB.');
  }
}
```

#### 2. Invalid File Type
```typescript
const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];

if (!allowedTypes.includes(file.type)) {
  alert('Invalid file type. Please upload PDF, JPEG, or PNG.');
  return;
}
```

#### 3. Network Error
```typescript
try {
  await uploadFile.mutateAsync({ file, type: 'LOGO' });
} catch (error) {
  if (error.message.includes('No response from server')) {
    alert('Network error. Please check your connection.');
  } else {
    alert(`Upload failed: ${error.message}`);
  }
}
```

---

## Best Practices

### 1. File Validation

Always validate files before uploading:

```typescript
const validateFile = (file: File): string | null => {
  // Check size (10MB max)
  if (file.size > 10 * 1024 * 1024) {
    return 'File size exceeds 10MB';
  }

  // Check type
  const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    return 'Invalid file type. Only PDF, JPEG, and PNG are allowed.';
  }

  return null; // Valid
};

// Usage
const error = validateFile(file);
if (error) {
  alert(error);
  return;
}
```

### 2. Progress Feedback

Always show progress for better UX:

```typescript
const [progress, setProgress] = useState(0);

const upload = useUploadKYCDocument((progress) => {
  setProgress(progress);
});

// Show progress bar
{upload.isPending && (
  <div className="progress-bar">
    <div style={{ width: `${progress}%` }} />
    <span>{progress}%</span>
  </div>
)}
```

### 3. Error Messages

Provide clear error messages:

```typescript
try {
  await upload.mutateAsync({ file, documentType: 'TAX_ID' });
  toast.success('Document uploaded successfully!');
} catch (error) {
  toast.error(error.message || 'Upload failed. Please try again.');
}
```

### 4. Cache Invalidation

Invalidate queries after upload:

```typescript
import { useQueryClient } from '@tanstack/react-query';

const queryClient = useQueryClient();
const upload = useUploadKYCDocument();

const handleUpload = async () => {
  await upload.mutateAsync({ file, documentType: 'TAX_ID' });
  
  // Invalidate KYC documents list
  queryClient.invalidateQueries({ queryKey: ['kyc-documents'] });
};
```

### 5. Cleanup

Clear file inputs after successful upload:

```typescript
const fileInputRef = useRef<HTMLInputElement>(null);

const handleUpload = async () => {
  await upload.mutateAsync({ file, documentType: 'TAX_ID' });
  
  // Clear input
  if (fileInputRef.current) {
    fileInputRef.current.value = '';
  }
  setFile(null);
};
```

---

## Conclusion

The Files Service provides a robust, type-safe solution for handling file uploads in the ZitoPay application. Key achievements:

- ✅ Specialized file upload client for proper multipart/form-data handling
- ✅ Progress tracking for better UX
- ✅ Full TypeScript type safety
- ✅ React Query integration for efficient state management
- ✅ Comprehensive error handling
- ✅ Support for multiple file upload scenarios

For questions or improvements, refer to:
- `lib/fileUploadClient.ts` - File upload client
- `features/files/api/index.ts` - API functions
- `features/files/hooks/index.ts` - React Query hooks
- `features/files/types/index.ts` - Type definitions
